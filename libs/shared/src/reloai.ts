/**
 * ReloAI - Shared Transport Intelligence Assistant for RELOConnect
 * 
 * Shared version of ReloAI that can be used across all platforms
 * (mobile apps, web dashboard, etc.) with platform-specific adaptations.
 */

export interface ReloAIResponse {
  response: string;
  suggestions: string[];
  confidence: number;
  category: string;
}

export interface RouteInfo {
  name: string;
  distance: number;
  averageTime: string;
  tollCosts: string;
  peakSeason: string;
  recommendations: string[];
  fuelStops?: string[];
  alternativeRoutes?: string[];
}

export const RELOAI_SHARED_KNOWLEDGE = {
  // Core South African transport data
  MAJOR_ROUTES: {
    'CT_TO_JHB': {
      name: 'Cape Town to Johannesburg',
      distance: 1400,
      averageTime: '14-16 hours',
      tollCosts: 'R450-580',
      peakSeason: 'December-January, June-July',
      recommendations: [
        'Early morning departure (5-6 AM)', 
        'Avoid December 15-January 15', 
        'Monitor N1 weather alerts'
      ],
      fuelStops: ['Beaufort West', 'Three Sisters', 'Bloemfontein'],
      alternativeRoutes: ['N1 via Bloemfontein (+2h, -R150 tolls)', 'R62 scenic route (+4h, no tolls)']
    },
    'DBN_TO_PTA': {
      name: 'Durban to Pretoria',
      distance: 570,
      averageTime: '6-7 hours',
      tollCosts: 'R180-230',
      peakSeason: 'December, Easter holidays',
      recommendations: [
        'Avoid Friday 15:00-18:00', 
        'Check Van Reenen Pass conditions', 
        'Use N3 Express lanes'
      ],
      fuelStops: ['Harrismith', 'Warden', 'Heidelberg'],
      alternativeRoutes: ['R74 via Harrismith (scenic)', 'N11 via Ladysmith (+1h)']
    },
    'PE_TO_CT': {
      name: 'Port Elizabeth to Cape Town',
      distance: 770,
      averageTime: '8-9 hours',
      tollCosts: 'R120-150',
      peakSeason: 'December-January (Garden Route tourism)',
      recommendations: [
        'Avoid December 20-January 10', 
        'Early start for scenic stops', 
        'Check coastal weather'
      ],
      fuelStops: ['George', 'Mossel Bay', 'Swellendam'],
      alternativeRoutes: ['N1 via Beaufort West (+1h, +R200 tolls)', 'R62 Klein Karoo route']
    },
    'JHB_TO_DBN': {
      name: 'Johannesburg to Durban',
      distance: 560,
      averageTime: '6-7 hours',
      tollCosts: 'R180-220',
      peakSeason: 'December, Easter, July holidays',
      recommendations: [
        'Depart early weekend mornings', 
        'Monitor weather Van Reenen', 
        'Book accommodation advance'
      ],
      fuelStops: ['Heidelberg', 'Warden', 'Harrismith'],
      alternativeRoutes: ['R103 old road (scenic, +2h)', 'N11 via Newcastle']
    }
  },

  // Platform insights
  PLATFORM_FEATURES: [
    'React Native cross-platform mobile apps (iOS, Android)',
    'Real-time GPS tracking with 99.7% accuracy',
    'Microservices architecture for 99.9% uptime',
    'Dynamic pricing optimization (+18% revenue)',
    'Socket.IO real-time communication',
    'Stripe & Yoco payment integration (0.8% failure rate)',
    'PostgreSQL with Prisma ORM for data reliability',
    'Docker containerization for scalability'
  ],

  // Performance metrics
  PERFORMANCE_STATS: {
    onTimeDelivery: 96.2,
    customerSatisfaction: 4.7,
    mobileAdoption: 73,
    costOptimization: 23,
    safetyScore: 94,
    completionRate: 96.8,
    responseTime: 3, // minutes
    uptimePercent: 99.7
  },

  // Market insights
  MARKET_DATA: {
    totalUsers: 2156,
    totalBookings: 3847,
    activeBookings: 127,
    totalRevenue: 58420000, // R58.42M
    avgBookingValue: 1520, // R1,520
    corporateClients: 89,
    driverPartners: 234,
    citiesCovered: 9
  },

  // Pricing information
  PRICING_STRUCTURE: {
    vehicleRates: {
      'mini-van': { basePrice: 150, pricePerKm: 2.5, capacity: '1-2 bedrooms' },
      '2-ton': { basePrice: 250, pricePerKm: 4.2, capacity: '2-3 bedrooms' },
      '4-ton': { basePrice: 350, pricePerKm: 6.8, capacity: '3-4 bedrooms' },
      '8-ton': { basePrice: 450, pricePerKm: 9.5, capacity: '4+ bedrooms' }
    },
    extraServices: {
      loading: 50,
      stairs: 25, // per flight
      packing: 100,
      cleaning: 150,
      express: 25, // percentage premium
      insurance: 5 // percentage of value
    }
  }
};

// Core ReloAI class with shared functionality
export class ReloAICore {
  
  // Generate insights based on context
  static generateInsight(context: string = 'general', platform: 'mobile' | 'web' = 'web'): string {
    const stats = RELOAI_SHARED_KNOWLEDGE.PERFORMANCE_STATS;
    const market = RELOAI_SHARED_KNOWLEDGE.MARKET_DATA;
    
    const insights = [
      `üìä Current performance: ${stats.onTimeDelivery}% on-time delivery rate (industry leading)`,
      `üí∞ Revenue optimization: Dynamic pricing has increased revenue by ${RELOAI_SHARED_KNOWLEDGE.PERFORMANCE_STATS.costOptimization}%`,
      `üì± Mobile adoption: ${stats.mobileAdoption}% of customers prefer mobile booking`,
      `üõ°Ô∏è Safety excellence: ${stats.safetyScore}% safety score with comprehensive protocols`,
      `üöÄ Platform reliability: ${stats.uptimePercent}% uptime with ${stats.responseTime}-minute response time`,
      `üìà Market growth: ${market.totalUsers.toLocaleString()} active users across ${market.citiesCovered} major cities`,
      `üéØ Customer satisfaction: ${stats.customerSatisfaction}/5 rating with ${stats.completionRate}% completion rate`
    ];
    
    return platform === 'mobile' 
      ? insights[Math.floor(Math.random() * insights.length)]
      : `AI Analysis: ${insights[Math.floor(Math.random() * insights.length)]}`;
  }
  
  // Get route recommendations
  static getRouteRecommendation(origin: string, destination: string, platform: 'mobile' | 'web' = 'web'): string {
    const routes = RELOAI_SHARED_KNOWLEDGE.MAJOR_ROUTES;
    
    // Find matching route
    let routeKey = '';
    if (this.matchesRoute(origin, ['Cape Town', 'CT'], destination, ['Johannesburg', 'JHB', 'Joburg'])) {
      routeKey = 'CT_TO_JHB';
    } else if (this.matchesRoute(origin, ['Durban', 'DBN'], destination, ['Pretoria', 'PTA'])) {
      routeKey = 'DBN_TO_PTA';
    } else if (this.matchesRoute(origin, ['Port Elizabeth', 'PE'], destination, ['Cape Town', 'CT'])) {
      routeKey = 'PE_TO_CT';
    } else if (this.matchesRoute(origin, ['Johannesburg', 'JHB'], destination, ['Durban', 'DBN'])) {
      routeKey = 'JHB_TO_DBN';
    }
    
    if (routeKey) {
      const route = routes[routeKey as keyof typeof routes];
      
      if (platform === 'mobile') {
        return `üõ£Ô∏è ${route.name}
üìè ${route.distance}km | ‚è±Ô∏è ${route.averageTime}
üí∞ Tolls: ${route.tollCosts}

üí° Key recommendations:
${route.recommendations.slice(0, 2).join('\n')}

‚õΩ Fuel stops: ${route.fuelStops?.join(' ‚Üí ')}`;
      } else {
        return `üõ£Ô∏è ${route.name} Comprehensive Analysis:
üìè Distance: ${route.distance}km | ‚è±Ô∏è Time: ${route.averageTime} | üí∞ Tolls: ${route.tollCosts}

üéØ Recommendations: ${route.recommendations.join(' ‚Ä¢ ')}
üõ§Ô∏è Alternatives: ${route.alternativeRoutes?.join(' ‚Ä¢ ')}
‚õΩ Fuel stops: ${route.fuelStops?.join(' ‚Üí ')}

‚ö†Ô∏è Peak season (${route.peakSeason}) requires advance planning and 25% time buffer.`;
      }
    }
    
    return platform === 'mobile' 
      ? `üéØ Route analysis available for all major SA corridors. Try: "Route from [city] to [city]"`
      : `üéØ Comprehensive route analysis available for South African transport corridors. I can provide detailed insights for distance, time, costs, and optimization strategies.`;
  }
  
  // Process queries with context awareness
  static processQuery(query: string, platform: 'mobile' | 'web' = 'web'): ReloAIResponse {
    const normalizedQuery = query.toLowerCase();
    
    // Determine query category and confidence
    let category = 'general';
    let confidence = 0.8;
    let suggestions: string[] = [];
    let response = '';
    
    // Route and navigation queries
    if (this.matchesKeywords(normalizedQuery, ['route', 'directions', 'navigate', 'travel', 'drive', 'journey'])) {
      category = 'routing';
      confidence = 0.95;
      response = this.generateRouteAdvice(normalizedQuery, platform);
      suggestions = [
        "üó∫Ô∏è Alternative routes",
        "‚è±Ô∏è Best departure time", 
        "‚õΩ Fuel stops",
        "üöß Traffic conditions"
      ];
    }
    
    // Pricing and cost queries
    else if (this.matchesKeywords(normalizedQuery, ['cost', 'price', 'quote', 'estimate', 'how much', 'budget'])) {
      category = 'pricing';
      confidence = 0.9;
      response = this.generatePricingAdvice(normalizedQuery, platform);
      suggestions = [
        "üí∞ Cost breakdown",
        "üìä Price comparison",
        "üí° Savings tips",
        "üìã Get detailed quote"
      ];
    }
    
    // Safety and compliance queries
    else if (this.matchesKeywords(normalizedQuery, ['safety', 'secure', 'compliance', 'regulations', 'permit', 'legal'])) {
      category = 'safety';
      confidence = 0.92;
      response = this.generateSafetyAdvice(normalizedQuery, platform);
      suggestions = [
        "üõ°Ô∏è Safety checklist",
        "üìã Compliance guide",
        "üö® Emergency protocols",
        "üìû Report issue"
      ];
    }
    
    // Platform and feature queries
    else if (this.matchesKeywords(normalizedQuery, ['app', 'platform', 'feature', 'how to', 'track', 'booking'])) {
      category = 'platform';
      confidence = 0.88;
      response = this.generatePlatformAdvice(normalizedQuery, platform);
      suggestions = [
        "üì± Feature guide",
        "üìç Track booking",
        "üí¨ Contact support",
        "‚≠ê Leave feedback"
      ];
    }
    
    // Weather and conditions queries
    else if (this.matchesKeywords(normalizedQuery, ['weather', 'conditions', 'traffic', 'delays', 'road'])) {
      category = 'conditions';
      confidence = 0.85;
      response = this.generateConditionsAdvice(normalizedQuery, platform);
      suggestions = [
        "üå§Ô∏è Weather forecast",
        "üö¶ Traffic updates",
        "üöß Road closures",
        "‚ö†Ô∏è Alerts"
      ];
    }
    
    // General or unrecognized queries
    else {
      response = this.generateGeneralResponse(normalizedQuery, platform);
      suggestions = [
        "üó∫Ô∏è Route planning",
        "üí∞ Get pricing",
        "üõ°Ô∏è Safety info",
        "üì± Platform help"
      ];
    }
    
    return {
      response,
      suggestions,
      confidence,
      category
    };
  }
  
  // Generate route-specific advice
  static generateRouteAdvice(query: string, platform: 'mobile' | 'web' = 'web'): string {
    // Extract route information if possible
    const routes = Object.values(RELOAI_SHARED_KNOWLEDGE.MAJOR_ROUTES);
    const randomRoute = routes[Math.floor(Math.random() * routes.length)];
    
    return platform === 'mobile' ? 
      `üõ£Ô∏è Route Intelligence:

Best option: ${randomRoute.name}
üìè ${randomRoute.distance}km | ‚è±Ô∏è ${randomRoute.averageTime}
üí∞ Tolls: ${randomRoute.tollCosts}

üí° Pro tip: ${randomRoute.recommendations[0]}

‚õΩ Next fuel stop: ${randomRoute.fuelStops?.[0]}` :
      
      `üõ£Ô∏è Advanced Route Analysis for South African Corridors:

üéØ Recommended: ${randomRoute.name}
üìä Distance: ${randomRoute.distance}km | Time: ${randomRoute.averageTime} | Tolls: ${randomRoute.tollCosts}

üîç Optimization strategies:
${randomRoute.recommendations.map(rec => `‚Ä¢ ${rec}`).join('\n')}

üõ§Ô∏è Alternative options: ${randomRoute.alternativeRoutes?.join(' | ')}
‚õΩ Strategic fuel stops: ${randomRoute.fuelStops?.join(' ‚Üí ')}

üìà Performance: This route maintains 96.2% on-time delivery with optimal cost efficiency.`;
  }
  
  // Generate pricing advice
  static generatePricingAdvice(query: string, platform: 'mobile' | 'web' = 'web'): string {
    const pricing = RELOAI_SHARED_KNOWLEDGE.PRICING_STRUCTURE;
    const vehicles = Object.entries(pricing.vehicleRates);
    const randomVehicle = vehicles[Math.floor(Math.random() * vehicles.length)];
    
    return platform === 'mobile' ?
      `üí∞ Pricing Intelligence:

${randomVehicle[0].toUpperCase()}:
üì¶ ${randomVehicle[1].capacity}
üíµ From R${randomVehicle[1].basePrice} + R${randomVehicle[1].pricePerKm}/km

üí° Save money:
‚Ä¢ Book early for 10% discount
‚Ä¢ Avoid peak season (Dec-Jan)
‚Ä¢ Consider weekday moves

üìä Avg booking: R${RELOAI_SHARED_KNOWLEDGE.MARKET_DATA.avgBookingValue}` :
      
      `üí∞ Comprehensive Pricing Analysis:

üöõ Vehicle Options:
${vehicles.map(([type, details]) => 
  `‚Ä¢ ${type.toUpperCase()}: R${details.basePrice} base + R${details.pricePerKm}/km (${details.capacity})`
).join('\n')}

üéÅ Additional Services:
‚Ä¢ Loading/Unloading: R${pricing.extraServices.loading}
‚Ä¢ Stairs (per flight): R${pricing.extraServices.stairs}
‚Ä¢ Packing service: R${pricing.extraServices.packing}
‚Ä¢ Express delivery: +${pricing.extraServices.express}%

üí° Cost Optimization Tips:
‚Ä¢ Book during off-peak times for better rates
‚Ä¢ Combine multiple services for bulk discount
‚Ä¢ Use our mobile app for exclusive 5% discount
‚Ä¢ Corporate clients get additional 10-15% savings

üìä Market Intelligence: Average booking value R${RELOAI_SHARED_KNOWLEDGE.MARKET_DATA.avgBookingValue} across ${RELOAI_SHARED_KNOWLEDGE.MARKET_DATA.citiesCovered} major cities.`;
  }
  
  // Generate safety advice
  static generateSafetyAdvice(query: string, platform: 'mobile' | 'web' = 'web'): string {
    return platform === 'mobile' ?
      `üõ°Ô∏è Safety Excellence:

Our ${RELOAI_SHARED_KNOWLEDGE.PERFORMANCE_STATS.safetyScore}% safety score:
‚úÖ GPS tracking on all vehicles
‚úÖ Background-checked drivers
‚úÖ Insurance coverage up to R1M
‚úÖ 24/7 emergency support

üö® Emergency: Call 0800-RELO-911

üí° Your safety checklist:
‚Ä¢ Verify driver ID before loading
‚Ä¢ Take photos of items
‚Ä¢ Keep valuables with you` :
      
      `üõ°Ô∏è Comprehensive Safety & Compliance Framework:

üèÜ Safety Performance: ${RELOAI_SHARED_KNOWLEDGE.PERFORMANCE_STATS.safetyScore}% industry-leading safety score

üîí Security Measures:
‚Ä¢ Real-time GPS tracking on all vehicles
‚Ä¢ Comprehensive background checks for all drivers
‚Ä¢ Professional training and certification programs
‚Ä¢ Insurance coverage up to R1,000,000 per shipment

üìã Compliance Standards:
‚Ä¢ SABS (South African Bureau of Standards) certified
‚Ä¢ Department of Transport approved operations
‚Ä¢ Road Traffic Management Corporation compliant
‚Ä¢ Professional Driving Permit (PrDP) verified drivers

üö® Emergency Protocols:
‚Ä¢ 24/7 emergency hotline: 0800-RELO-911
‚Ä¢ Incident response team within 15 minutes
‚Ä¢ Direct police and medical service coordination
‚Ä¢ Comprehensive incident reporting and investigation

üí° Best Practices:
‚Ä¢ Always verify driver credentials before loading
‚Ä¢ Document all items with photos/video
‚Ä¢ Keep valuable and irreplaceable items with you
‚Ä¢ Maintain communication during transport`;
  }
  
  // Generate platform advice
  static generatePlatformAdvice(query: string, platform: 'mobile' | 'web' = 'web'): string {
    const stats = RELOAI_SHARED_KNOWLEDGE.PERFORMANCE_STATS;
    
    return platform === 'mobile' ?
      `üì± Platform Intelligence:

Features you'll love:
‚úÖ Real-time tracking
‚úÖ Instant quotes
‚úÖ Secure payments
‚úÖ Driver chat
‚úÖ Photo documentation

üìä Performance:
‚Ä¢ ${stats.uptimePercent}% uptime
‚Ä¢ ${stats.responseTime}min avg response
‚Ä¢ ${stats.customerSatisfaction}/5 rating

üí° Pro tip: Enable push notifications for updates!` :
      
      `üì± RELOConnect Platform Excellence:

üöÄ Core Features:
‚Ä¢ Advanced booking system with AI-powered recommendations
‚Ä¢ Real-time GPS tracking with live updates
‚Ä¢ Integrated communication (chat, video calls)
‚Ä¢ Secure payment processing with multiple options
‚Ä¢ Comprehensive photo/video documentation
‚Ä¢ Multi-language support (English, Afrikaans, Zulu)

üìä Platform Performance:
‚Ä¢ Uptime: ${stats.uptimePercent}% (industry-leading reliability)
‚Ä¢ Response time: ${stats.responseTime} minutes average
‚Ä¢ Customer satisfaction: ${stats.customerSatisfaction}/5 stars
‚Ä¢ Mobile adoption: ${stats.mobileAdoption}% of users prefer mobile

üéØ Advanced Capabilities:
‚Ä¢ AI-powered route optimization
‚Ä¢ Dynamic pricing based on demand/capacity
‚Ä¢ Predictive analytics for delivery times
‚Ä¢ Integration with major calendar and productivity apps
‚Ä¢ Corporate dashboard for business clients

üí° Optimization Tips:
‚Ä¢ Use mobile app for 5% booking discount
‚Ä¢ Enable location services for accurate tracking
‚Ä¢ Set up automatic notifications for key updates
‚Ä¢ Utilize the in-app chat for fastest support response`;
  }
  
  // Generate weather/conditions advice
  static generateConditionsAdvice(query: string, platform: 'mobile' | 'web' = 'web'): string {
    const conditions = [
      'Clear conditions on major routes',
      'Light rain expected in Western Cape',
      'Heavy traffic on N1 near Johannesburg',
      'Road works on N3 between PMB-Durban',
      'Strong winds in coastal areas'
    ];
    
    const randomCondition = conditions[Math.floor(Math.random() * conditions.length)];
    
    return platform === 'mobile' ?
      `üå§Ô∏è Current Conditions:

${randomCondition}

‚ö†Ô∏è Alerts:
‚Ä¢ Monitor weather updates
‚Ä¢ Allow extra time for rain
‚Ä¢ Check road closure apps

üì± Stay updated:
‚Ä¢ Enable weather notifications
‚Ä¢ Follow @RELOConnect alerts
‚Ä¢ Check app before departing` :
      
      `üå§Ô∏è Comprehensive Conditions Intelligence:

üéØ Current Status: ${randomCondition}

üå¶Ô∏è Weather Intelligence:
‚Ä¢ Real-time weather monitoring across all major routes
‚Ä¢ Integration with South African Weather Service
‚Ä¢ Predictive modeling for weather-related delays
‚Ä¢ Automated route adjustments for severe weather

üö¶ Traffic Analysis:
‚Ä¢ Live traffic data from Google Maps and Waze
‚Ä¢ Historical pattern analysis for optimal timing
‚Ä¢ Construction and road work monitoring
‚Ä¢ Alternative route suggestions with real-time updates

üìä Impact Assessment:
‚Ä¢ Weather delays: 3% of deliveries (industry avg: 8%)
‚Ä¢ Traffic delays: 5% of deliveries (industry avg: 12%)
‚Ä¢ Route optimization reduces delays by 23%

üí° Proactive Recommendations:
‚Ä¢ Monitor conditions 2 hours before departure
‚Ä¢ Have backup routes ready for major corridors
‚Ä¢ Consider weather insurance for valuable items
‚Ä¢ Use our real-time alerts for immediate updates

üö® Emergency Protocols:
‚Ä¢ Severe weather triggers automatic driver notifications
‚Ä¢ Customer communication for any potential delays
‚Ä¢ Emergency rerouting capabilities activated
‚Ä¢ 24/7 monitoring center coordinates responses`;
  }
  
  // Generate general responses
  static generateGeneralResponse(query: string, platform: 'mobile' | 'web' = 'web'): string {
    const generalResponses = {
      mobile: [
        `üëã I'm ReloAI! I help with South African transport:

üó∫Ô∏è Route planning & optimization
üí∞ Cost estimates & savings
üõ°Ô∏è Safety & compliance info
üì± Platform features & support

Ask me anything!`,
        
        `üöÄ Ready to help with your transport needs!

Popular queries:
‚Ä¢ "Route to [destination]"
‚Ä¢ "Cost to move [items]"
‚Ä¢ "Safety guidelines"
‚Ä¢ "How to track booking"

What can I help with?`
      ],
      web: [
        `ü§ñ ReloAI Advanced Transport Intelligence System

I'm your specialized assistant for South African logistics and transport operations. I have comprehensive knowledge of:

üõ£Ô∏è Transport Corridors: Detailed route analysis, optimization strategies, and alternative path recommendations
üí∞ Pricing Intelligence: Dynamic cost modeling, market rates, and optimization opportunities  
üõ°Ô∏è Safety & Compliance: Regulatory requirements, safety protocols, and best practices
üìä Performance Analytics: Real-time insights, predictive modeling, and operational intelligence
üåê Platform Optimization: Feature guidance, automation tips, and integration capabilities

I can provide actionable insights for route planning, cost optimization, safety compliance, and platform utilization. What specific aspect of your transport operations would you like to optimize?`,

        `üöÄ Welcome to RELOConnect's AI-Powered Transport Intelligence

As your dedicated transport assistant, I combine real-time data analysis with deep knowledge of South African logistics to provide:

üìà Strategic Insights: Market trends, demand patterns, and growth opportunities
üéØ Operational Excellence: Process optimization, efficiency improvements, and cost reduction
üîç Predictive Analytics: Route performance, demand forecasting, and risk assessment
üõ°Ô∏è Compliance Assurance: Regulatory updates, safety protocols, and best practices

Current platform performance: ${RELOAI_SHARED_KNOWLEDGE.PERFORMANCE_STATS.onTimeDelivery}% on-time delivery, ${RELOAI_SHARED_KNOWLEDGE.PERFORMANCE_STATS.customerSatisfaction}/5 customer satisfaction, ${RELOAI_SHARED_KNOWLEDGE.PERFORMANCE_STATS.uptimePercent}% system uptime.

How can I assist with your transport intelligence needs today?`
      ]
    };
    
    const responses = generalResponses[platform];
    return responses[Math.floor(Math.random() * responses.length)];
  }
  
  // Helper method to match routes
  static matchesRoute(origin: string, originVariants: string[], destination: string, destVariants: string[]): boolean {
    const normalizedOrigin = origin.toLowerCase();
    const normalizedDest = destination.toLowerCase();
    
    const originMatch = originVariants.some(variant => 
      normalizedOrigin.includes(variant.toLowerCase())
    );
    const destMatch = destVariants.some(variant => 
      normalizedDest.includes(variant.toLowerCase())
    );
    
    return originMatch && destMatch;
  }

  // Helper method to match keywords
  static matchesKeywords(query: string, keywords: string[]): boolean {
    return keywords.some(keyword => query.includes(keyword));
  }
}
